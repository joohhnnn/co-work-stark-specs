# StateDiff 说明

## 1. 什么是 StateDiff

**StateDiff**（状态差异）是指在区块链系统（如 Starknet）中，经过一系列交易或区块处理后，系统状态（如账户余额、合约存储、内存等）发生的所有变更的集合。它本质上描述了“区块前后”系统状态的差异。

在 Stone Prover/STARK 证明系统中，StateDiff 的作用主要有：
- **状态归纳**：明确指出哪些账户、合约、存储槽等发生了变化。
- **证明输入**：为 STARK 证明提供状态转移的输入和输出，确保区块处理的正确性。
- **高效同步**：便于节点间高效同步和状态重建。

## 2. StateDiff 的实现原理

StateDiff 并不是单独的一个类或结构体，而是通过执行追踪（Execution Trace）和内存/寄存器的变更集合体现的。

### 实现流程
1. **执行追踪（Execution Trace）**
   - 记录每条指令执行时的 CPU 状态（如寄存器、内存、程序计数器等）。
   - 追踪所有交易的每一步执行。
2. **状态变更归纳**
   - 通过遍历所有交易的执行追踪，统计和归纳出内存、账户、合约等的变更集合。
   - 这些集合即为“StateDiff”。
3. **区块处理流程**
   - 依次执行区块内所有交易，收集追踪数据。
   - 对比区块前后的状态，提取出 StateDiff。
   - StateDiff 作为 STARK 证明的输入，证明区块状态转移的正确性。

### 关键点
- StateDiff 关注的是“变更”，即只记录发生变化的部分，而不是全量状态。
- 其生成依赖于完整的执行追踪和状态快照对比。

## 3. 相关代码结构与文件分布

- **执行追踪与状态变更相关的核心代码主要分布在：**
  - `src/starkware/air/cpu/board/cpu_air_trace_context.h`：追踪上下文与数据结构
  - `src/starkware/air/cpu/component/cpu_component.inl`：指令执行与追踪记录
  - `2.executionTrace.md`：文档说明，含核心结构与流程
  - 其它如 `poseidon.inl`、`keccak.inl` 等文件，记录特定哈希组件的状态变更

- **核心结构体与方法：**
  - `TraceEntry` 结构体：记录每步指令的 CPU 状态
  - `WriteTrace` 方法：执行指令并记录详细过程
  - `Trace` 类：以列式存储所有追踪数据

## 4. 总结

StateDiff 是区块链系统中描述状态转移的核心数据结构。它通过执行追踪和状态归纳，精确记录区块处理后系统状态的所有变更，为 STARK 证明和节点同步提供了基础。其实现依赖于对每一步执行的详细追踪和最终状态的对比归纳，是保证区块链安全性和可验证性的关键环节。